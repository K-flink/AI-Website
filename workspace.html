<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Collab Central</title>
  <meta name="description" content="Collab Storytelling" />
  <style>
    /* -- Reset & base ----------------------------------------------------- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    :root {
      --bg: #0f1221;
      --panel: #1b316b;
      --panel-2: #1b316b;
      --muted: #c7c9e4;
      --text: #eef0ff;
      --brand: #7c5cff;
      --brand-2: #2ee0a7;
      --accent: #ff8b6a;
      --ok: #42d392;
      --warn: #ffce6a;
      --danger: #ff6b88;
      --ring: 0 0 0 3px rgba(124,92,255,.35);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
body {
  margin: 0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  color: var(--text);
  background: linear-gradient(135deg, #7c5cff, #2ee0a7, #ff8b6a, #ffce6a);
  background-size: 400% 400%;
  animation: bg-shift 20s ease infinite;
  letter-spacing: .2px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

@keyframes bg-shift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}


    /* -- Layout ----------------------------------------------------------- */
    .shell { display:grid; grid-template-rows: auto 1fr; min-height:100vh; }
    header {
      position: sticky; top: 0; z-index: 50;
      display:flex; align-items:center; justify-content:space-between;
      padding: 18px clamp(16px, 4vw, 36px);
      background: linear-gradient(180deg, rgba(31, 44, 97, 0.9), rgba(31,44,97,.9)),
                  radial-gradient(800px 200px at 80% -40%, rgba(124,92,255,.18), transparent);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .brand { display:flex; gap:14px; align-items:center; }
    .logo {
      width: 40px; height: 40px; border-radius: 10px;
      background: conic-gradient(from 180deg at 50% 50%, var(--brand), var(--brand-2), var(--accent), var(--brand));
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.12), 0 8px 30px rgba(124,92,255,.35);
    }
    .brand h1 { font-size: clamp(18px, 2.2vw, 24px); font-weight: 800; letter-spacing: .3px; }
    .brand small { display:block; font-size: 12px; color: var(--muted); opacity:.8; }

    .header-actions { display:flex; gap:10px; align-items:center; }

    main { display:grid; grid-template-columns: 300px 1fr; gap: 18px; padding: 18px clamp(16px, 4vw, 36px) 28px; }
    @media (max-width: 980px) { main { grid-template-columns: 1fr; } }

    /* -- Panels ----------------------------------------------------------- */
    .panel { background: linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--panel);
      border: 1px solid rgba(255,255,255,.08); border-radius: var(--radius); box-shadow: var(--shadow);
    }
    .panel .panel-head { padding:16px 16px 8px; border-bottom:1px dashed rgba(255,255,255,.07); }
    .panel .panel-body { padding: 12px 14px 16px; }

    /* -- Inputs ----------------------------------------------------------- */
    .row { display:flex; gap:10px; align-items:center; }
    .stack { display:grid; gap:8px; }
    label { font-size: 12px; color: var(--muted); }
    input[type="text"], input[type="search"], textarea, select {
      width:100%; background: var(--panel-2); color: var(--text);
      border: 1px solid rgba(255,255,255,.08); border-radius: 12px; outline: none;
      padding: 12px 12px; font-size: 14px;
      transition: box-shadow .15s ease, border-color .2s ease, transform .05s ease;
    }
    textarea { min-height: 110px; resize: vertical; }
    input:focus, textarea:focus, select:focus { box-shadow: var(--ring); border-color: rgba(124,92,255,.7); }

    .pill {
      display:inline-flex; align-items:center; gap:8px; padding:10px 12px; font-weight:600; font-size:13px;
      border-radius: 999px; background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08); color: var(--text); cursor: pointer;
      transition: transform .05s ease, background .2s ease, opacity .2s ease;
    }
    .pill:hover { background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); }
    .pill:active { transform: translateY(1px) scale(.99); }
    .pill .dot { width:8px; height:8px; border-radius:50%; background: var(--brand-2); box-shadow: 0 0 0 3px rgba(46,224,167,.2); }

    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:12px 14px;
      background: linear-gradient(180deg, #8d76ff, #6a4cff); color: white; font-weight: 700; letter-spacing:.2px;
      border: none; border-radius: 14px; cursor: pointer; box-shadow: 0 10px 25px rgba(124,92,255,.35);
      transition: transform .05s ease, filter .2s ease, box-shadow .2s ease; user-select: none;
    }
    .btn.secondary { background: linear-gradient(180deg, #22284e, #1a2144); color: var(--muted); box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); }
    .btn.ghost { background: transparent; color: var(--text); box-shadow: inset 0 0 0 1px rgba(255,255,255,.1); }
    .btn:hover { filter: brightness(1.05); }
    .btn:active { transform: translateY(1px) scale(.995); }

    .tag { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius: 999px; font-size:12px; color: var(--muted); border:1px solid rgba(255,255,255,.1); background: rgba(255,255,255,.02); }
    .tag .s { width:8px; height:8px; border-radius:50%; background: var(--brand); }

    /* -- Sidebar ---------------------------------------------------------- */
    .sidebar .panel-body { display:grid; gap:14px; }
    .tabs { display:flex; flex-wrap:wrap; gap:8px; }

    .account-card { display:grid; gap:10px; }
    .account-card .who { display:flex; align-items:center; gap:10px; }
    .avatar { width:40px; height:40px; border-radius: 10px; background: linear-gradient(135deg, #2ee0a7, #7c5cff); display:grid; place-items:center; font-weight:800; color:#0c1026; }

    /* -- Story list ------------------------------------------------------- */
    .story-grid { display:grid; grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) ); gap: 16px; }
    .story-card { position:relative; padding:16px; border-radius: 16px; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)), var(--panel);
      border:1px solid rgba(255,255,255,.08); box-shadow: var(--shadow); cursor:pointer; transition: transform .06s ease, border-color .2s ease, background .2s ease; }
    .story-card:hover { transform: translateY(-2px); border-color: rgba(124,92,255,.35); }
    .story-card h3 { font-size: 16px; margin-bottom:8px; }
    .story-card p { font-size: 13px; min-height: 38px; }
    .story-card .meta { display:flex; justify-content:space-between; align-items:center; margin-top:10px; font-size:12px; color:var(--muted); }

    .search-row { display:flex; gap:10px; align-items:center; }

    /* -- Modal ------------------------------------------------------------ */
    dialog { width: min(880px, 92vw); border: none; border-radius: 16px; padding:0; background: linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--panel);
      color: var(--text); box-shadow: 0 20px 80px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.08); }
    dialog::backdrop { backdrop-filter: blur(6px); background: rgba(5,8,20,.55); }
    .modal-head { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px dashed rgba(255,255,255,.08); }
    .modal-body { padding: 14px 16px 18px; }

    /* -- Story view ------------------------------------------------------- */
    .story-title { font-size: 20px; margin-bottom: 6px; }
    .story-sub { font-size: 13px; color: var(--muted); }
    .entries { margin-top: 14px; display:grid; gap: 10px; }
    .entry { padding: 12px; border-radius: 12px; background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02)); border: 1px solid rgba(255,255,255,.08); }
    .entry .by { font-size: 12px; color: var(--muted); margin-bottom: 6px; }

    .divider { height:1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,.08), transparent); margin: 10px 0; }

    .flex { display:flex; gap:10px; align-items:center; }
    .between { display:flex; align-items:center; justify-content:space-between; }

    .empty { border:1px dashed rgba(255,255,255,.12); border-radius: 14px; padding: 16px; text-align:center; color: var(--muted); }

    .kbd { font-size: 12px; border:1px solid rgba(255,255,255,.14); border-bottom-width:2px; border-radius: 8px; padding: 2px 6px; background: rgba(255,255,255,.04); }

    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand" title="Collab Storytelling">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Collab Central</h1>
          <small>Collaborative Storytelling</small>
        </div>
      </div>
      <div class="header-actions">
        <button class="btn" id="btn-new">‚ûï New story</button>
        <button class="btn secondary" id="btn-how">‚ùî How it works</button>
      </div>
    </header>

    <main>
      <!-- Sidebar -->
      <section class="panel sidebar" aria-label="Sidebar">
        <div class="panel-head">
          <div class="row between">
            <strong>Workspace</strong>
            <span class="tag" title="Local-first demo">
              <span class="s"></span> local-first
            </span>
          </div>
        </div>
        <div class="panel-body">
          <div class="account-card">
            <div class="who">
              <div class="avatar" id="avatar">üôÇ</div>
              <div class="stack" style="flex:1">
                <label for="username">Your account name</label>
                <input id="username" type="text" placeholder="e.g. Kerri" />
              </div>
            </div>
            <div class="row">
              <button class="pill" id="save-username"><span class="dot"></span> Set account</button>
              <button class="pill" id="random-name">üé≤ Random</button>
            </div>
          </div>

          <div class="stack">
            <label>Browse</label>
            <div class="tabs" role="tablist" aria-label="Views">
              <button class="pill" data-view="public">üåç Public Lobby</button>
              <button class="pill" data-view="mine">üîí My Private</button>
              <button class="pill" data-view="shared">ü§ù Shared with me</button>
              <button class="pill" data-view="all">üìö All</button>
            </div>
          </div>

          <div class="stack">
            <label for="q">Search stories</label>
            <div class="search-row">
              <input id="q" type="search" placeholder="title, owner, tag‚Ä¶ (‚åò/Ctrl K)" />
              <button class="btn ghost" id="clear-q">‚úï</button>
            </div>
          </div>

          <div class="stack">
            <label>Shortcuts</label>
            <div class="row" style="flex-wrap:wrap">
              <span class="tag"><span class="s"></span> <b>N</b>&nbsp;new story</span>
              <span class="tag"><span class="s"></span> <b>‚åò/Ctrl</b>&nbsp;+&nbsp;<b>K</b> search</span>
              <span class="tag"><span class="s"></span> <b>Enter</b> submit</span>
            </div>
          </div>

          <div class="stack">
            <label>Tips</label>
            <p style="font-size:13px">This is a local‚Äëfirst demo: your stories live in your browser using <b>localStorage</b>. Open another tab with a different account name to play together; it syncs live between tabs.</p>
          </div>
        </div>
      </section>

      <!-- Content -->
      <section class="panel" aria-live="polite">
        <div class="panel-head between">
          <div>
            <strong id="view-title">Public Lobby</strong>
            <p id="view-sub" style="margin-top:2px">Everyone can read & add to these stories.</p>
          </div>
          <div class="row">
            <button class="btn ghost" id="btn-export">‚¨áÔ∏è Export</button>
            <button class="btn ghost" id="btn-import">‚¨ÜÔ∏è Import</button>
          </div>
        </div>
        <div class="panel-body">
          <div id="story-list" class="story-grid"></div>
          <div id="empty-state" class="empty hidden">No stories here yet. Be the first to <button class="btn" id="cta-new" style="margin-left:8px">create one</button>!</div>
        </div>
      </section>
    </main>
  </div>

  <!-- New story modal -->
  <dialog id="modal-new">
    <div class="modal-head">
      <div>
        <h3>Create a new story</h3>
        <p class="story-sub">Define visibility and collaborators; you can change this later.</p>
      </div>
      <button class="btn ghost" data-close>‚úï</button>
    </div>
    <div class="modal-body">
      <div class="stack">
        <div class="stack">
          <label for="new-title">Title</label>
          <input id="new-title" type="text" placeholder="e.g. The Midnight Train" />
        </div>
        <div class="stack">
          <label for="new-desc">Short description</label>
          <input id="new-desc" type="text" placeholder="What is this story about?" />
        </div>
        <div class="row" style="align-items:flex-end">
          <div class="stack" style="flex:1">
            <label for="new-vis">Visibility</label>
            <select id="new-vis">
              <option value="public">üåç Public ‚Äî anyone can add</option>
              <option value="private">üîí Private ‚Äî only you & invited people</option>
            </select>
          </div>
          <div class="stack" style="flex:1">
            <label for="new-collab">Add collaborators (comma‚Äëseparated)</label>
            <input id="new-collab" type="text" placeholder="e.g. Alex, Jordan, Sam" />
          </div>
        </div>
        <div class="row between">
          <button class="btn secondary" data-close>Cancel</button>
          <button class="btn" id="create-story">Create story</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Story view modal -->
  <dialog id="modal-story">
    <div class="modal-head">
      <div>
        <div class="row" style="gap:8px; align-items:baseline">
          <h3 id="story-title" class="story-title">Story</h3>
          <span id="story-visibility" class="tag"><span class="s"></span> visibility</span>
        </div>
        <div class="row" style="gap:10px; flex-wrap:wrap">
          <span class="story-sub" id="story-desc">desc</span>
          <span class="story-sub">‚Ä¢</span>
          <span class="story-sub" id="story-owner">owner</span>
          <span class="story-sub" id="story-updated">updated</span>
        </div>
      </div>
      <button class="btn ghost" data-close>‚úï</button>
    </div>
    <div class="modal-body">
      <div class="stack">
        <div class="entries" id="entries"></div>
        <div class="divider"></div>
        <div id="edit-locked" class="empty hidden">You don't have access to add to this story. Ask the owner to invite your account.</div>
        <div id="composer" class="stack">
          <label for="entry">Add your paragraph</label>
          <textarea id="entry" placeholder="Write the next lines‚Ä¶"></textarea>
          <div class="between">
            <div class="row">
              <button class="btn ghost" id="btn-settings">‚öôÔ∏è Story settings</button>
            </div>
            <div class="row">
              <span id="count" class="tag"><span class="s"></span> <span id="chars">0</span> chars</span>
              <button class="btn" id="post">Post</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Story settings modal -->
  <dialog id="modal-settings">
    <div class="modal-head">
      <div><h3>Story settings</h3><p class="story-sub">Change visibility, collaborators, or delete.</p></div>
      <button class="btn ghost" data-close>‚úï</button>
    </div>
    <div class="modal-body">
      <div class="stack">
        <div class="row" style="align-items:flex-end">
          <div class="stack" style="flex:1">
            <label for="set-vis">Visibility</label>
            <select id="set-vis">
              <option value="public">üåç Public</option>
              <option value="private">üîí Private</option>
            </select>
          </div>
          <div class="stack" style="flex:2">
            <label for="set-collab">Collaborators (comma‚Äëseparated)</label>
            <input id="set-collab" type="text" placeholder="Alex, Jordan, Sam" />
          </div>
        </div>
        <div class="row between">
          <button class="btn danger" id="delete-story" style="background: linear-gradient(180deg, #ff7b93, #ff5b78);">Delete story</button>
          <button class="btn" id="save-settings">Save</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- How it works -->
  <dialog id="modal-how">
    <div class="modal-head between">
      <h3>How it works</h3>
      <button class="btn ghost" data-close>‚úï</button>
    </div>
    <div class="modal-body">
      <ol style="line-height:1.7">
        <li>Set an <b>account name</b> in the sidebar (this is your identity).</li>
        <li>Browse the <b>Public Lobby</b> or switch to <b>My Private</b> to see your private stories.</li>
        <li>Click <b>New story</b> to create one, choose <i>Public</i> or <i>Private</i>, and add collaborators.</li>
        <li>Open a story to <b>append paragraphs</b>. Entries are ordered by time and credit the author.</li>
        <li>Open this page in another tab with a different account name to simulate multiple users. It syncs live via <code>storage</code> events.</li>
      </ol>
      <p class="story-sub" style="margin-top:10px">Note: This is front‚Äëend only. For real authentication & permissions, wire it to a backend (Supabase, Firebase, or your API).</p>
    </div>
  </dialog>

  <script>
  /*****************************************************************
   * Collab Storytelling ‚Äî Local‚Äëfirst single file demo
   * Data model (stored in localStorage key `collabStoriesV1`):
   * {
   *   stories: [ { id, title, desc, visibility:'public'|'private', owner, collaborators:[name], createdAt, updatedAt, entries:[{author, text, ts}] } ],
   *   users:   [ 'Alice', 'Bob' ]  // seen accounts (for avatar color seeds)
   * }
   *****************************************************************/

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const storeKey = 'collabStoriesV1';
  const state = { view: 'public', me: '', data: { stories: [], users: [] }, current: null };

  // --- Utilities -----------------------------------------------------
  const now = () => new Date().toISOString();
  const id = () => crypto.randomUUID();
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const fmtTime = iso => new Date(iso).toLocaleString();
  const initials = name => (name||'?').split(/\s+/).map(p=>p[0]).join('').slice(0,2).toUpperCase();
  const uniq = arr => [...new Set(arr)];

  function save() {
    localStorage.setItem(storeKey, JSON.stringify(state.data));
    // let other tabs know
    localStorage.setItem(storeKey+':ping', now());
  }
  function load() {
    const raw = localStorage.getItem(storeKey);
    if (raw) try { state.data = JSON.parse(raw); } catch {}
    else seed();
  }
  function seed() {
    state.data = {
      stories: [
        {
          id: id(), title: 'The Lighthouse at the Edge', desc: 'A public story that anyone can extend.',
          visibility: 'public', owner: 'System', collaborators: [], createdAt: now(), updatedAt: now(),
          entries: [
            { author:'System', text: 'The foghorn moaned like an old whale as dusk dissolved into ink. On the cliff, the lighthouse blinked‚Äîone for the living, once for the lost.', ts: now() }
          ]
        }
      ],
      users: []
    };
    save();
  }

  // --- Account handling ----------------------------------------------
  function setMe(name) {
    state.me = name.trim();
    $('#username').value = state.me;
    $('#avatar').textContent = initials(state.me || 'üôÇ');
    if (state.me && !state.data.users.includes(state.me)) {
      state.data.users.push(state.me);
      save();
    }
    render();
  }

  // --- Story filters --------------------------------------------------
  const canRead = (story) => {
    if (story.visibility === 'public') return true;
    if (!state.me) return false;
    return story.owner === state.me || story.collaborators.includes(state.me);
  }
  const canWrite = (story) => {
    if (story.visibility === 'public') return true;
    if (!state.me) return false;
    return story.owner === state.me || story.collaborators.includes(state.me);
  }

  const views = {
    public: s=> s.visibility==='public',
    mine:   s=> s.visibility==='private' && s.owner===state.me,
    shared: s=> s.visibility==='private' && s.owner!==state.me && canRead(s),
    all:    s=> canRead(s)
  };

  // --- Rendering ------------------------------------------------------
  function render() {
    // header view text
    const viewMeta = {
      public: ['Public Lobby','Everyone can read & add to these stories.'],
      mine: ['My Private','Only you & collaborators can see these.'],
      shared: ['Shared with me','Private stories where you are invited.'],
      all: ['All readable','Everything you can access.']
    }[state.view];
    $('#view-title').textContent = viewMeta[0];
    $('#view-sub').textContent = viewMeta[1];

    const q = $('#q').value.trim().toLowerCase();
    const list = $('#story-list');
    list.innerHTML = '';

    const stories = state.data.stories
      .filter(views[state.view])
      .filter(s => canRead(s))
      .filter(s => !q || [s.title, s.desc, s.owner, ...(s.collaborators||[])].join(' ').toLowerCase().includes(q))
      .sort((a,b)=> (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt));

    $('#empty-state').classList.toggle('hidden', stories.length>0);

    stories.forEach(s => list.appendChild(card(s)));
  }

  function card(s) {
    const el = document.createElement('article');
    el.className='story-card';
    el.innerHTML = `
      <div class="row" style="justify-content:space-between; gap:8px">
        <h3>${escapeHTML(s.title)}</h3>
        <span class="tag" title="${s.visibility}"><span class="s" style="background:${s.visibility==='public' ? 'var(--brand-2)' : 'var(--accent)'}"></span> ${s.visibility}</span>
      </div>
      <p>${escapeHTML(s.desc||'')}</p>
      <div class="meta">
        <span>‚úçÔ∏è ${escapeHTML(s.owner)}</span>
        <span>üïí ${timeAgo(s.updatedAt)}</span>
      </div>`;
    el.addEventListener('click', ()=> openStory(s.id));
    return el;
  }

  function timeAgo(ts) {
    const d = (Date.now() - new Date(ts).getTime())/1000;
    if (d < 60) return `${Math.floor(d)}s ago`;
    if (d < 3600) return `${Math.floor(d/60)}m ago`;
    if (d < 86400) return `${Math.floor(d/3600)}h ago`;
    return new Date(ts).toLocaleDateString();
  }

  // --- Story modals ---------------------------------------------------
  function openNewModal() {
    $('#new-title').value='';
    $('#new-desc').value='';
    $('#new-vis').value='public';
    $('#new-collab').value='';
    $('#modal-new').showModal();
  }

  function openStory(id) {
    const s = state.data.stories.find(x=>x.id===id);
    if (!s) return;
    state.current = s.id;

    $('#story-title').textContent = s.title;
    $('#story-desc').textContent = s.desc || '';
    $('#story-owner').textContent = `by ${s.owner}`;
    $('#story-updated').textContent = `‚Ä¢ updated ${timeAgo(s.updatedAt)}`;
    const vis = $('#story-visibility');
    vis.innerHTML = `<span class="s" style="background:${s.visibility==='public' ? 'var(--brand-2)' : 'var(--accent)'}"></span> ${s.visibility}`;

    // entries
    const box = $('#entries');
    box.innerHTML='';
    s.entries.forEach(e => {
      const li = document.createElement('div');
      li.className='entry';
      li.innerHTML = `<div class="by">${escapeHTML(e.author)} ‚Äî ${fmtTime(e.ts)}</div><div>${renderText(e.text)}</div>`;
      box.appendChild(li);
    });

    // access
    const writable = canWrite(s);
    $('#composer').classList.toggle('hidden', !writable);
    $('#edit-locked').classList.toggle('hidden', writable);

    $('#entry').value='';
    $('#chars').textContent='0';
    $('#modal-story').showModal();
  }

  function openSettings() {
    const s = current(); if (!s) return;
    $('#set-vis').value = s.visibility;
    $('#set-collab').value = s.collaborators.join(', ');
    $('#modal-settings').showModal();
  }

  function current() { return state.data.stories.find(x=>x.id===state.current); }

  // --- Handlers -------------------------------------------------------
  $('#btn-new').addEventListener('click', openNewModal);
  $('#cta-new').addEventListener('click', openNewModal);
  $('#btn-how').addEventListener('click', ()=> $('#modal-how').showModal());
  $$('#modal-new [data-close], #modal-story [data-close], #modal-settings [data-close], #modal-how [data-close]')
    .forEach(x=> x.addEventListener('click', e=> e.target.closest('dialog').close()));

  $('#create-story').addEventListener('click', ()=> {
    const title = $('#new-title').value.trim();
    if (!title) return alert('Please enter a title');
    if (!state.me) return alert('Set your account name first');

    const s = {
      id: id(), title,
      desc: $('#new-desc').value.trim(),
      visibility: $('#new-vis').value,
      owner: state.me,
      collaborators: parseNames($('#new-collab').value),
      createdAt: now(), updatedAt: now(),
      entries: []
    };
    state.data.stories.push(s);
    save();
    $('#modal-new').close();
    render();
    openStory(s.id);
  });

  $('#post').addEventListener('click', ()=> {
    const s = current(); if (!s) return;
    if (!canWrite(s)) return alert('You do not have access to write to this story.');
    const text = $('#entry').value.trim();
    if (!text) return;
    s.entries.push({ author: state.me || 'Anonymous', text, ts: now() });
    s.updatedAt = now();
    save();
    openStory(s.id); // rerender
  });

  $('#entry').addEventListener('input', e=> {
    const t = e.target.value;
    $('#chars').textContent = String(t.length);
  });

  $('#btn-settings').addEventListener('click', openSettings);
  $('#save-settings').addEventListener('click', ()=>{
    const s = current(); if (!s) return;
    s.visibility = $('#set-vis').value;
    s.collaborators = parseNames($('#set-collab').value);
    s.updatedAt = now();
    save();
    $('#modal-settings').close();
    openStory(s.id);
    render();
  });
  $('#delete-story').addEventListener('click', ()=>{
    const s = current(); if (!s) return;
    if (!confirm('Delete this story permanently?')) return;
    state.data.stories = state.data.stories.filter(x=>x.id!==s.id);
    save();
    $('#modal-settings').close();
    $('#modal-story').close();
    render();
  });

  // account
  $('#save-username').addEventListener('click', ()=> setMe($('#username').value||''));
  $('#random-name').addEventListener('click', ()=> setMe(randomName()));
  $('#username').addEventListener('keydown', e=> { if (e.key==='Enter') setMe($('#username').value||''); });

  // search
  $('#q').addEventListener('input', render);
  $('#clear-q').addEventListener('click', ()=> { $('#q').value=''; render(); });
  document.addEventListener('keydown', e=>{
    if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase()==='k') { e.preventDefault(); $('#q').focus(); }
    if ((e.key==='n' || e.key==='N') && !/input|textarea/i.test(document.activeElement.tagName)) openNewModal();
  });

  // view tabs
  $$('.tabs .pill').forEach(btn=> btn.addEventListener('click', ()=>{
    state.view = btn.dataset.view; render();
    $$('.tabs .pill').forEach(b=> b.ariaSelected = (b===btn) ? 'true' : 'false');
  }));

  // import/export
  $('#btn-export').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href:url, download:'collab-stories.json' });
    a.click(); URL.revokeObjectURL(url);
  });
  $('#btn-import').addEventListener('click', ()=>{
    const inp = Object.assign(document.createElement('input'), { type:'file', accept:'.json,application/json' });
    inp.onchange = () => {
      const f = inp.files[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = () => { try {
        const data = JSON.parse(reader.result);
        if (!data || !Array.isArray(data.stories)) throw new Error('Invalid file');
        state.data = data; save(); render();
      } catch(e){ alert('Import failed: '+ e.message); } };
      reader.readAsText(f);
    };
    inp.click();
  });

  // cross-tab sync
  window.addEventListener('storage', e=>{
    if (e.key===storeKey || e.key===storeKey+':ping') { load(); render(); }
  });

  // helpers
  function parseNames(str) {
    return uniq(str.split(',').map(s=>s.trim()).filter(Boolean));
  }
  function escapeHTML(s='') { return s.replace(/[&<>\"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])); }
  function renderText(t='') { return escapeHTML(t).replace(/\n/g,'<br>'); }

  function randomName() {
    const A = ['Nova','Echo','Lyra','Kai','Riven','Mira','Sable','Juno','Rune','Orion','Vega','Zara'];
    const B = ['Quill','Harbor','Dawn','Vale','Skye','Cinder','Bluff','Fable','Crest','Flint'];
    return A[Math.floor(Math.random()*A.length)] + ' ' + B[Math.floor(Math.random()*B.length)];
  }

  // init
  load();
  setMe(localStorage.getItem('collab.me') || '');
  $('#save-username').addEventListener('click', ()=> localStorage.setItem('collab.me', state.me));
  $('#random-name').addEventListener('click', ()=> localStorage.setItem('collab.me', state.me));
  render();

  </script>
</body>
</html>